<script>

const chat=document.getElementById("chat");
const input=document.getElementById("question");
const ring=document.getElementById("ring");
const mouth=document.getElementById("mouth");
const avatar=document.getElementById("avatar");


let speaking=false;


/* ADD CHAT MESSAGE */

function add(text,type){

const div=document.createElement("div");

div.className=type;

div.innerText=text;

chat.appendChild(div);

chat.scrollTop=chat.scrollHeight;

}



/* BLINK SYSTEM */

function blink(){

avatar.style.opacity=".4";

setTimeout(()=>{
avatar.style.opacity="1";
},120);

}

/* random blink every 3-6 sec */

setInterval(()=>{
blink();
},3000+Math.random()*3000);




/* BREATHING IDLE */

setInterval(()=>{

if(!speaking){

ring.style.transform="translate(-50%,-50%) scale(1.05)";

setTimeout(()=>{

ring.style.transform="translate(-50%,-50%) scale(1)";

},2000);

}

},4000);




/* FIND BEST FEMALE VOICE */

function getVoice(){

const voices=speechSynthesis.getVoices();

for(let v of voices){

if(
v.name.toLowerCase().includes("female") ||
v.name.toLowerCase().includes("zira") ||
v.name.toLowerCase().includes("samantha")
){
return v;
}

}

return voices[0];

}



/* SPEAK WITH TRUE LIFELIKE ANIMATION */

function speak(text){

const speech=new SpeechSynthesisUtterance(text);

speech.voice=getVoice();

speech.rate=.95;

speech.pitch=1.1;


speech.onstart=()=>{

speaking=true;

ring.classList.add("talkingRing");

mouth.classList.add("talkingMouth");

};


speech.onend=()=>{

speaking=false;

ring.classList.remove("talkingRing");

mouth.classList.remove("talkingMouth");

};


/* safety stop previous speech */

speechSynthesis.cancel();

speechSynthesis.speak(speech);

}



/* ASK SERVER */

async function ask(){

const q=input.value.trim();

if(!q)return;


add("You: "+q,"user");

input.value="";


add("T.A.R.A is analyzing...","tara");


try{

const res=await fetch("/ask",{

method:"POST",

headers:{
"Content-Type":"application/json"
},

body:JSON.stringify({question:q})

});


const data=await res.json();


chat.lastChild.remove();


add("T.A.R.A: "+data.answer,"tara");


speak(data.answer);

}
catch{

chat.lastChild.remove();


const fallback="Verify tow points and follow manufacturer safety procedures.";


add("T.A.R.A: "+fallback,"tara");


speak(fallback);

}

}



/* BUTTON */

askBtn.onclick=ask;



/* ENTER KEY */

input.addEventListener("keypress",e=>{

if(e.key==="Enter")ask();

});



/* VOICE INPUT */

if("webkitSpeechRecognition"in window){

const rec=new webkitSpeechRecognition();

rec.continuous=false;

rec.interimResults=false;

rec.lang="en-US";


voiceBtn.onclick=()=>{

rec.start();

};


rec.onresult=e=>{

input.value=e.results[0][0].transcript;

ask();

};

}

else{

voiceBtn.style.display="none";

}



/* preload voices */

speechSynthesis.onvoiceschanged=()=>{

speechSynthesis.getVoices();

};

</script>
